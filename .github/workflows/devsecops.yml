name: DevSecOps CI/CD Pipeline
on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  devsecops:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create env files
        run: |
          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          cp frontend/.env.example frontend/.env

      # --- Instalacion reproducible ---

      - name: Install users-service
        run: npm ci
        working-directory: backend/users-service

      - name: Install academic-service
        run: npm ci
        working-directory: backend/academic-service

      - name: Install api-gateway
        run: npm ci
        working-directory: backend/api-gateway

      - name: Install frontend
        run: npm ci
        working-directory: frontend

      # --- Analisis de calidad (ESLint) ---

      - name: Lint users-service
        run: npm run lint
        working-directory: backend/users-service

      - name: Lint academic-service
        run: npm run lint
        working-directory: backend/academic-service

      - name: Lint api-gateway
        run: npm run lint
        working-directory: backend/api-gateway

      - name: Lint frontend
        run: npm run lint
        working-directory: frontend

      # --- Testing automatico ---

      - name: Test users-service
        run: npm test
        working-directory: backend/users-service

      - name: Test academic-service
        run: npm test
        working-directory: backend/academic-service

      - name: Test api-gateway
        run: npm test
        working-directory: backend/api-gateway

      - name: Test frontend
        run: npm test
        working-directory: frontend

      # --- SAST (Semgrep) ---

      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: SAST users-service
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=WARNING || true
        working-directory: backend/users-service

      - name: SAST academic-service
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=WARNING || true
        working-directory: backend/academic-service

      - name: SAST api-gateway
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=WARNING || true
        working-directory: backend/api-gateway

      - name: SAST frontend
        run: semgrep --config=auto --severity=WARNING || true
        working-directory: frontend

      # --- SCA (npm audit) ---

      - name: Audit users-service
        run: npm audit --audit-level=critical
        working-directory: backend/users-service

      - name: Audit academic-service
        run: npm audit --audit-level=critical
        working-directory: backend/academic-service

      - name: Audit api-gateway
        run: npm audit --audit-level=critical
        working-directory: backend/api-gateway

      - name: Audit frontend
        run: npm audit --audit-level=critical
        working-directory: frontend

      # --- Build de contenedores ---

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          docker compose -f backend/docker-compose.yml build
          docker tag users-service:latest users-service:$SHORT_SHA
          docker tag academic-service:latest academic-service:$SHORT_SHA
          docker tag api-gateway:latest api-gateway:$SHORT_SHA

      # --- Seguridad de contenedores (Trivy) ---

      - name: Trivy scan users-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: users-service:latest
          severity: CRITICAL
          exit-code: 1

      - name: Trivy scan academic-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: academic-service:latest
          severity: CRITICAL
          exit-code: 1

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: api-gateway:latest
          severity: CRITICAL
          exit-code: 1

      - name: Trivy scan frontend
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: backend-frontend:latest
          severity: CRITICAL
          exit-code: 1

      # --- Smoke test ---

      - name: Start containers
        run: |
          docker compose -f backend/docker-compose.yml up -d
          sleep 15

      - name: Health check
        run: curl -f http://localhost:3000/health

      - name: Shutdown
        if: always()
        run: docker compose -f backend/docker-compose.yml down || true
